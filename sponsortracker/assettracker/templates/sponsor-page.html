{% extends "assettracker-layout.html" %}

{% block title %}Asset Tracker - {{ sponsor.name }}{% endblock %}

{% block css %}
.missing {
    background-color:red;
}

.received {
    background-color:lime;
}

.error {
    color:red;
}

.removable {
    display:none;
}

div.asset a:hover + a.removable, div.asset a.removable:hover {
    display:inline;
}
{% endblock %}

{% block content %}
<h1>{{ sponsor.name }}</h1>
<div><span style="font-weight:bold">Level</span>: {{ sponsor.level.label }}</div>

{% for id in forms %}
    <span style="display:inline; font-weight:bold">{{ forms[id].data_field().label.text }}</span>:&nbsp;
    <div id="{{ id }}_edit" style="display:inline;">
        <span id="{{ id }}_value" style="display:inline;">{{ forms[id].data_field().data or "" }}</span>
    </div>
    
    {% if not readonly %}
        <div id="{{ id }}_edit_button" style="display:inline;">
            <a href="javascript:void(0);" onclick="edit('{{ id }}');"><img style="display:inline;" src="{{ url_for('assettracker.static', filename='edit.png') }}" /></a>
        </div>
        <form id="{{ id }}_form" style="display:inline;" method="POST" action="{{ url_for('assettracker.info_' + id, id=sponsor.id) }}">
            {% for field in forms[id] %}
                {% if field == forms[id].data_field() %}
                <div id="{{ id }}_field" style="display:none;">
                    {{ field(style="display:inline; vertical-align: text-top") }}&nbsp;
                </div>
                {% elif field.type in ("CSRFTokenField", "HiddenField") %}
                    {{ field }}
                {% endif %}
            {% endfor %}
        </form>
        
        <div id="{{ id }}_field_button" style="display:none;">
            <a href="javascript:void(0);" onclick="save('{{ id }}');"><img style="display:inline;" src="{{ url_for('assettracker.static', filename='save.png') }}" /></a>
            <a href="javascript:void(0);" onclick="cancel('{{ id }}');"><img style="display:inline;" src="{{ url_for('assettracker.static', filename='cancel.png') }}" /></a>
        </div>
    {% endif %}
    <br />
{% endfor %}

{% for error in errors %}
  <br />{{ error }}
{% endfor %}

<h2>Assets</h2>
<p>
    {% if not readonly %}
    <a href="{{ url_for('assettracker.upload_asset', id=sponsor.id) }}">Upload Asset</a><br />
    <form method="POST" action="{{ url_for('assettracker.send_asset_request', id=sponsor.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        
        <!-- <input type="submit" value="Send Asset Request" /> -->
    </form>
    {% endif %}
</p>

{% for type in sponsor.level.assets|sort(attribute="label") %}
<div style="float:left; width:200px;">
    {% if type in sponsor.assets_by_type %} {% set cls="received" %} {% else %} {% set cls="missing" %} {% endif %}
    <p class="{{ cls }}" style="text-align:center; padding-left:5px; padding-right:5px;">{{ type.label }}</p>
    {% for asset in sponsor.assets_by_type[type] %}
    <div class="asset" style="position:relative; left:50px;">
        <a href="{{ asset.url }}" target="_blank"><img src="{{ asset.thumbnail_url }}" alt="{{ asset.name }}"></img></a>
        <a class="removable" href="javascript:void(0);" onclick="delete_asset({{ asset.id }})">
            <img style="vertical-align:top; position:relative; left:-20px;" src="{{ url_for('assettracker.static', filename='delete.png') }}"></img>
        </a>
    </div>
    <br />
    {% endfor %}
</div>

<div style="float:left; width:20px;">&nbsp;</div>
{% endfor %}

{% endblock %}

{% block js %}
{% if not readonly %}
function save(formId) {
    document.getElementById(formId + "_form").submit();
}

function cancel(fieldId) {
    document.getElementById(fieldId + "_field").style.display = "none";
    document.getElementById(fieldId + "_field_button").style.display = "none";
    document.getElementById(fieldId + "_edit").style.display = "inline";
    document.getElementById(fieldId + "_edit_button").style.display = "inline";
}

function edit(fieldId) {
    document.getElementById(fieldId + "_field").style.display = "inline";
    document.getElementById(fieldId + "_field_button").style.display = "inline";
    document.getElementById(fieldId + "_edit").style.display = "none";
    document.getElementById(fieldId + "_edit_button").style.display = "none";
}

function delete_asset(id) {
    var form = document.createElement("form");
    form.setAttribute("method", "POST");
    form.setAttribute("action", "{{ url_for('assettracker.delete_asset', id=sponsor.id) }}");
    
    var csrfField = document.createElement("input");
    csrfField.setAttribute("type", "hidden");
    csrfField.setAttribute("name", "csrf_token");
    csrfField.setAttribute("value", "{{ csrf_token() }}");
    form.appendChild(csrfField);
    
    var hiddenField = document.createElement("input");
    hiddenField.setAttribute("type", "hidden");
    hiddenField.setAttribute("name", "asset-id");
    hiddenField.setAttribute("value", id);
    form.appendChild(hiddenField);
    
    document.body.appendChild(form);
    
    form.submit();
}
{% endif %}
{% endblock %}